<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Twosome Simulator</title>
  <style>
    /* 기본 레이아웃 - 텍스트 중심 UI */
    :root{--bg:#fafafa;--card:#fff;--accent:#333}
    body{font-family:system-ui,-apple-system,\"Noto Sans KR\",sans-serif;background:var(--bg);color:var(--accent);margin:0;padding:24px}
    h1{margin:0 0 12px}
    .screen{max-width:780px;margin:0 auto;background:var(--card);padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .menu-list{list-style:none;padding:0;margin:12px 0}
    .menu-list li{margin:8px 0}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .small{font-size:13px;padding:6px 10px}
    .row{display:flex;gap:12px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}

    /* 레시피북 팝업 */
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);}
    .popup{background:#fff;padding:16px;border-radius:8px;max-width:640px;width:90%;max-height:80vh;overflow:auto}
    .popup h3{margin:0 0 8px}
    .close{float:right;border:0;background:transparent;font-weight:700}

    /* 게임 화면 텍스트 스타일 */
    .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .slots{display:flex;gap:8px;margin:14px 0}
    .slot{min-width:140px;padding:10px;border:2px dashed #ccc;border-radius:6px;text-align:left}
    .ingredients{display:flex;flex-direction:column;gap:8px}
    .ingredient{padding:10px;border-radius:6px;border:1px solid #e0e0e0}
    .disabled{opacity:0.5}
    .hidden{display:none}
    .status{margin-top:8px}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="screen" id="app">
    <h1>Twosome Simulator</h1>

    <!-- HOME VIEW -->
    <div id="homeView">
      <ol class="menu-list">
        <li><button id="startBtn">1) 게임 시작</button></li>
        <li><button id="openBookBtn">2) 레시피북</button></li>
        <li><button id="optionsBtn">3) 옵션</button></li>
        <li><button id="quitBtn">4) 종료</button></li>
      </ol>

      <div class="row">
        <div>최고 점수: <span id="bestScore">0</span></div>
        <div>모드: <span id="currentMode">모든 메뉴</span></div>
      </div>
    </div>

    <!-- OPTIONS VIEW -->
    <div id="optionsView" class="hidden">
      <h2>옵션</h2>
      <div class="col">
        <label>타이머 설정</label>
        <div class="row">
          <button class="small" data-t=30>초급 30초</button>
          <button class="small" data-t=20>중급 20초</button>
          <button class="small" data-t=15>고급 15초</button>
        </div>

        <label>출제 필터</label>
        <div class="row">
          <button class="small" id="filterAll">모든 메뉴</button>
          <button class="small" id="filterHot">Hot만</button>
          <button class="small" id="filterIce">Ice만</button>
        </div>

        <div class="row">
          <button id="backFromOptions" class="small">뒤로가기</button>
        </div>
      </div>
    </div>

    <!-- GAME VIEW -->
    <div id="gameView" class="hidden">
      <div class="meta">
        <div><strong id="menuTitle">메뉴명</strong> (<span id="menuTemp">Hot</span>)</div>
        <div>시간: <span id="timer">10</span>s</div>
      </div>

      <div>점수: <span id="score">0</span> | 콤보: <span id="combo">0</span></div>

      <div class="slots" id="slots"></div>

      <div>
        <h4>재료 목록 (고정 순서로 노출)</h4>
        <div class="ingredients" id="ingredients"></div>
      </div>

      <div class="status" id="status"></div>

      <div class="row" style="margin-top:12px;">
        <button id="giveUpBtn">포기</button>
        <button id="nextBtn" class="hidden">다음 문제</button>
      </div>

      <div class="meta">
        <div><strong id="menuTitle">메뉴명</strong> (<span id="menuTemp">Hot</span>)</div>
        <div>
            남은 게임 시간: <span id="totalTimer">02:00</span>
        </div>
    </div>

    <!-- RESULT VIEW (간단) -->
    <div id="resultView" class="hidden">
      <h2 id="resultText">결과</h2>
      <div>획득 점수: <span id="lastScore">0</span></div>
      <div><button id="backHome">홈으로</button></div>
    </div>

  </div>

  <!-- 레시피북 팝업 (텍스트 팝업) -->
  <div id="recipePopup" class="overlay hidden">
    <div class="popup">
      <button class="close" id="closeBook">X</button>
      <h3>레시피북</h3>
      <pre id="recipeContent">loading...</pre>
    </div>
  </div>
  <script src="recipes.js"></script>
  <script>

// 상태 변수
let state = {
  timeLimit:10,
  filter:'all', // all | Hot | Ice
  current:null,
  timerId:null,
  remaining:0,
  score:0,
  combo:0,
  totalTime:120,      // 전체 게임 제한 시간 3분
  totalTimerId:null
};

// DOM 참조
const homeView = document.getElementById('homeView');
const optionsView = document.getElementById('optionsView');
const gameView = document.getElementById('gameView');
const resultView = document.getElementById('resultView');
const recipePopup = document.getElementById('recipePopup');

// 버튼들
document.getElementById('startBtn').onclick = startGame;
document.getElementById('openBookBtn').onclick = openBook;
document.getElementById('optionsBtn').onclick = ()=>showView('options');
document.getElementById('quitBtn').onclick = ()=>alert('창을 닫거나 새로고침 해주세요.');
document.getElementById('backFromOptions').onclick = ()=>showView('home');
document.getElementById('closeBook').onclick = closeBook;
document.getElementById('filterAll').onclick = ()=>{state.filter='all'; document.getElementById('currentMode').innerText='모든 메뉴';}
document.getElementById('filterHot').onclick = ()=>{state.filter='Hot'; document.getElementById('currentMode').innerText='Hot만';}
document.getElementById('filterIce').onclick = ()=>{state.filter='Ice'; document.getElementById('currentMode').innerText='Ice만';}

document.querySelectorAll('[data-t]').forEach(b=>b.onclick=(e)=>{state.timeLimit = Number(e.target.dataset.t); alert('타이머를 '+state.timeLimit+'초로 설정했습니다');});

document.getElementById('giveUpBtn').onclick = ()=>{stopTimer(); showResult(false)};
document.getElementById('backHome').onclick = ()=>{showView('home')};

// 레시피북 열기/닫기
function openBook(){
  renderRecipeBook();
  recipePopup.classList.remove('hidden');
}
function closeBook(){ recipePopup.classList.add('hidden'); }

function renderRecipeBook(){
  const grouped = {};
  RECIPES.forEach(r=>{
    if(!grouped[r.menu]) grouped[r.menu]={};
    grouped[r.menu][r.temp]=r.steps;
  });
  let out = '';
  Object.keys(grouped).forEach(menu=>{
    out += `"${menu}"\n`;
    ['Hot','Ice'].forEach(t=>{
      if(grouped[menu][t]){
        out += `  (${t})\n`;
        grouped[menu][t].forEach((s,i)=> out += `    ${i+1}. ${s}\n`);
      }
    });
    out += '\n';
  });
  document.getElementById('recipeContent').innerText = out;
}

// 화면 전환 도우미
function showView(name){
  homeView.classList.add('hidden');
  optionsView.classList.add('hidden');
  gameView.classList.add('hidden');
  resultView.classList.add('hidden');

  if(name==='home') homeView.classList.remove('hidden');
  if(name==='options') optionsView.classList.remove('hidden');
  if(name==='game') gameView.classList.remove('hidden');
  if(name==='result') resultView.classList.remove('hidden');
}

// 게임 시작
function startGame(){
  state.score = 0; 
  state.combo = 0;
  document.getElementById('score').innerText = state.score;
  
  showView('game');

  // 전체 게임 타이머 초기화
  state.totalTime = 120;
  startTotalTimer();

  nextProblem();
}

// 전체 게임 타이머
function startTotalTimer(){
  state.totalTimerId = setInterval(()=>{
    state.totalTime--;
    if(state.totalTime <= 0){
      stopTotalTimer();
      showResult(false);
      alert('TIME OVER!');
    }
  }, 1000);
}
function stopTotalTimer(){
  if(state.totalTimerId) clearInterval(state.totalTimerId);
  state.totalTimerId = null;
}

// 문제 선택
function pickRandomRecipe(){
  const pool = RECIPES.filter(r=> state.filter==='all' || r.temp===state.filter);
  if(pool.length===0) return null;
  const idx = Math.floor(Math.random()*pool.length);
  return JSON.parse(JSON.stringify(pool[idx])); // 복제
}

// 다음 문제
function nextProblem(){
  clearStateForProblem();

  const chosen = pickRandomRecipe();
  if(!chosen){ 
    alert('조건에 맞는 레시피가 없습니다. 옵션을 확인하세요.'); 
    showView('home'); 
    return; 
  }
  state.current = chosen;
  document.getElementById('menuTitle').innerText = chosen.menu;
  document.getElementById('menuTemp').innerText = chosen.temp;

  // 슬롯 렌더
  const slots = document.getElementById('slots'); 
  slots.innerHTML='';
  chosen.steps.forEach(()=>{
    const s = document.createElement('div'); 
    s.className='slot'; 
    s.innerText='___'; 
    slots.appendChild(s);
  });

  // 재료 목록 랜덤 배치
  const ing = document.getElementById('ingredients'); 
  ing.innerHTML='';
  const shuffledSteps = [...chosen.steps].sort(() => Math.random() - 0.5);
  shuffledSteps.forEach((it, i)=>{
    const d = document.createElement('div'); 
    d.className='ingredient'; 
    d.innerText = `${i+1}. ${it}`; 
    d.dataset.origIdx = chosen.steps.indexOf(it); 
    d.onclick = ()=>selectIngredient(Number(d.dataset.origIdx)); 
    ing.appendChild(d);
  });

  // 타이머 시작
  startTimer();
}

// 문제별 타이머 초기화
function clearStateForProblem(){
  stopTimer();
  state.remaining = state.timeLimit;
  document.getElementById('timer').innerText = state.remaining;
  document.getElementById('status').innerText = '';
  document.getElementById('nextBtn').classList.add('hidden');
}

// 문제별 타이머 시작/정지
function startTimer(){
  state.remaining = state.timeLimit;
  document.getElementById('timer').innerText = state.remaining;
  state.timerId = setInterval(()=>{
    state.remaining--;
    document.getElementById('timer').innerText = state.remaining;
    if(state.remaining<=0){ stopTimer(); checkAnswerTimeout(); }
  },1000);
}
function stopTimer(){ if(state.timerId) clearInterval(state.timerId); state.timerId = null; }

// 남은 게임시간 표시
function startTotalTimer(){
  updateTotalTimerDisplay();
  state.totalTimerId = setInterval(()=>{
    state.totalTime--;
    updateTotalTimerDisplay();

    if(state.totalTime <= 0){
      stopTotalTimer();
      saveScoreAndReturnHome();  // 전체 시간이 끝나면 점수 저장 후 홈 화면 이동
    }
  }, 1000);
}

function updateTotalTimerDisplay(){
  const minutes = Math.floor(state.totalTime / 60);
  const seconds = state.totalTime % 60;
  const formatted = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
  document.getElementById('totalTimer').innerText = formatted;
}

function saveScoreAndReturnHome(){
  // 최고 점수 갱신
  const bestEl = document.getElementById('bestScore');
  if(state.score > Number(bestEl.innerText)){
    bestEl.innerText = state.score;
  }

  alert('TIME OVER! 최종 점수: ' + state.score);
  showView('home');  // 홈 화면으로 이동
}



// 재료 선택
function selectIngredient(idx){
  const cur = state.current;
  const slots = document.querySelectorAll('.slot');
  const filledCount = Array.from(slots).filter(s=>s.dataset.filled==='1').length;
  if(filledCount >= cur.steps.length) return;

  const chosenText = cur.steps[idx];
  slots[filledCount].innerText = chosenText;
  slots[filledCount].dataset.filled = '1';

  let ok = true;
  for(let i=0;i<filledCount+1;i++){
    if(slots[i].innerText !== cur.steps[i]){ ok = false; break; }
  }

  if(!ok){
    stopTimer();
    state.combo = 0;
    state.score = Math.max(0, state.score - 20);
    document.getElementById('score').innerText = state.score;
    document.getElementById('status').innerText = '오답! -20점';
    document.getElementById('nextBtn').classList.remove('hidden');
    return;
  }

  const allFilled = Array.from(slots).every(s=>s.dataset.filled==='1');
  if(allFilled){
    stopTimer();
    const base = 100;
    const timeBonus = state.remaining * 5;
    state.combo += 1;
    const comboBonus = (state.combo>1)? state.combo*10 : 0;
    const gained = base + timeBonus + comboBonus;
    state.score += gained;
    document.getElementById('score').innerText = state.score;
    document.getElementById('status').innerText = `정답! +${gained} (기본${base} + 시간보너스${timeBonus} + 콤보${comboBonus})`;
    document.getElementById('nextBtn').classList.remove('hidden');
  }
}

//시간 초과
function checkAnswerTimeout(){
  // 콤보 초기화
  state.combo = 0;

  // 점수 감점
  const penalty = 20;
  state.score = Math.max(0, state.score - penalty);
  document.getElementById('score').innerText = state.score;

  // 상태 메시지 표시
  document.getElementById('status').innerText = `시간 초과! -${penalty}점`;
  
  // 다음 문제 버튼 표시
  document.getElementById('nextBtn').classList.remove('hidden');
}


// 다음 문제 버튼
document.getElementById('nextBtn').onclick = ()=>{ nextProblem(); };

// 결과 화면
function showResult(success){
  document.getElementById('lastScore').innerText = state.score;
  if(state.score > Number(document.getElementById('bestScore').innerText)){
    document.getElementById('bestScore').innerText = state.score;
  }
  stopTotalTimer();
  showView('result');
}

// 초기화: 홈으로
showView('home');

document.getElementById('giveUpBtn').onclick = () => {
  stopTimer();          // 현재 문제 타이머 멈춤
  stopTotalTimer();     // 전체 게임 타이머 멈춤 (총 3분 타이머)
  
  // 최고 점수 갱신
  const bestEl = document.getElementById('bestScore');
  if(state.score > Number(bestEl.innerText)){
    bestEl.innerText = state.score;
  }

  alert('포기했습니다! 최종 점수: ' + state.score);
  showView('home');     // 홈 화면으로 이동
}

  </script>
</body>
</html>
